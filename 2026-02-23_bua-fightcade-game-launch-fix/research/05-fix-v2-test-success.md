# Fix v2 Test — SUCCESS

Clean reinstall via updated `fightcade.sh` installer run on Batocera.

---

## Step 1: App Launched + Logged In (21:09 MST)

**Processes:**
- `sym_wine.sh` (PID 24618) — running, monitoring fc2-electron
- `fc2-electron` (PID 24629) — main UI + child processes

**Log sequence (timing fix confirmed):**
```
Initializing Wine prefix at /userdata/system/add-ons/fightcade/.wine...
Wine prefix initialized.
Creating symlink: /usr/bin/wine -> /userdata/system/add-ons/fightcade/usr/bin/wine
Fightcade launched.
Symlink created. Monitoring fc2-electron process...
fc2-electron is running.
```

Correct order: wineboot → sym_wine.sh → Fightcade2.sh. No timing race.

**State:**
| Component | Status |
|-----------|--------|
| Wine symlink `/usr/bin/wine` | Active |
| `xdg-open` shim `$HOME/bin/xdg-open` | Present (198B) |
| Wine prefix `.wine/` | Initialized |
| `sym_wine.sh` | Running, monitoring |
| `Resources/wine.sh` | Present (146B) |

## Step 2: Test Game — WORKING

User clicked Test Game. **Game launched successfully.**

**fcade.log:**
```
2026-02-23 21:12:54,401:INFO:Playing: fcade://play/fbneo/sfiii3nr1
```

**Full URL dispatch chain — confirmed working:**
```
fc2-electron
  → shell.openExternal("fcade://play/fbneo/sfiii3nr1")
  → $HOME/bin/xdg-open "fcade://play/fbneo/sfiii3nr1"    [our shim]
  → emulator/fcade.sh "fcade://play/fbneo/sfiii3nr1"      [upstream script]
  → fcade binary                                           [game coordinator]
  → ../../Resources/wine.sh fcadefbneo.exe sfiii3nr1       [our wine wrapper]
  → wine AppImage → fcadefbneo.exe sfiii3nr1               [FBNeo via Wine]
```

**Game processes (21:12 MST):**
- `wine.sh` (PID 26182) — called via `../../Resources/wine.sh` path ✓
- Wine AppImage wrapper (PID 26183)
- `wine` (PID 26185) — running `fcadefbneo.exe sfiii3nr1`
- `fcadefbneo.exe sfiii3nr1` (PID 26209) — **FBNeo emulator running at 110% CPU** (active game)
- `wineserver` (PID 26211)
- `winedevice.exe` (PID 26218, 26227)

Game: **Street Fighter III: 3rd Strike (New Revision 1)**

## Root Causes Confirmed and Fixed

| Root Cause | Fix Applied |
|------------|-------------|
| `xdg-open` missing on Batocera — fc2-electron had no way to dispatch `fcade://` URLs | Created `$HOME/bin/xdg-open` shim routing `fcade://` to upstream `fcade.sh`; prepended to `PATH` |
| `wineboot -u` blocking before `sym_wine.sh` could see fc2-electron — symlink removed prematurely | Moved wineboot initialization before `sym_wine.sh` start |
| `Resources/wine.sh` missing — `fcade` binary couldn't find Wine wrapper at `../../Resources/wine.sh` | Generated by installer at correct path (`$ADDONS_DIR/fightcade/Resources/wine.sh`) |

## Changes to `fightcade.sh` (single file)

1. **Added** `xdg-open` shim creation in port launcher (routes `fcade://` → `fcade.sh`)
2. **Added** `PATH` export so fc2-electron inherits the shim
3. **Reordered** wineboot to run before `sym_wine.sh` in port launcher
4. **Added** `Resources/wine.sh` generation in installer
5. **Removed** custom `fcade-quark` generation (upstream `fcade.sh` handles dispatch natively)
