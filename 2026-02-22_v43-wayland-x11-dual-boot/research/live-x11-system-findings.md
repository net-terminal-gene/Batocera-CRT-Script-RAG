# Live X11 Batocera System — CRT Stack Findings

**Date:** 2026-02-19
**System:** Batocera v42 X11 — kernel 6.15.11
**SSH source:** `batocera.local`
**Companion to:** `x11-crt-stack-requirements.md`, `batocera-linux-crt-integration.md`

---

> ⚠️ **IMPORTANT — READ BEFORE USING THIS DOCUMENT**
>
> This document captures a **Batocera v42** system with the **CRT Script already fully
> installed**. It is **not** a vanilla v43 baseline. Several findings here reflect the
> post-install state written by the CRT Script, not what is present on a fresh X11 image:
>
> - `20-amdgpu.conf.bak` exists because the CRT Script backed it up
> - `drm.edid_firmware=` and `video=DP-1:e` are in the kernel cmdline because Phase 2 put them there
> - The EDID binary, `10-monitor.conf`, `15-crt-monitor.conf`, `20-modesetting.conf` are all CRT Script output
> - The `batocera-resolution` binary is the **patched** version, not stock
>
> For the vanilla v43 baseline (what exists before the CRT Script runs), see
> `vanilla-x11-v43-live-findings.md`.
>
> The valuable content here is in **Sections 3, 7, 8, and 9** — the actual config file
> contents and `boot-custom.sh` behavior are confirmed live data not available elsewhere.
> **Section 6 contains a superseded conclusion** — see the correction note inline.

---

## System Identity

```
Batocera.linux 42
Kernel: 6.15.11 SMP PREEMPT_DYNAMIC x86_64
```

This is a fully configured X11 CRT build with the Batocera-CRT-Script installed and
running on a real CRT monitor (Nanao MS-929) via DP-1.

---

## 1. Binaries — All Confirmed Present

Every binary documented in the requirements doc is confirmed on the live system:

| Binary | Path | Size | Date |
|---|---|---|---|
| `switchres` | `/usr/bin/switchres` | 127KB | Oct 6 |
| `xrandr` | `/usr/bin/xrandr` | 64KB | Oct 6 |
| `batocera-resolution` | `/usr/bin/batocera-resolution` | 26KB | Nov 5 (patched) |
| `edid-decode` | `/usr/bin/edid-decode` | 397KB | Oct 6 |
| `geometry` | `/usr/bin/geometry` | 13KB | Oct 6 |
| `grid` | `/usr/bin/grid` | 85KB | Oct 6 |

**switchres version confirmed:** `Switchres 2.2.1` — matches `package/batocera/utils/switchres/`
version in the batocera.linux repo.

**libswitchres shared library:**
```
/usr/lib/libswitchres.so       → symlink
/usr/lib/libswitchres.so.2     → libswitchres.so.2.2.1
/usr/lib/libswitchres.so.2.2.1 → 142KB actual library
```

Note: The `libswitchres.so` symlink points through an unusual path
(`/x86_64/target/usr/lib/libswitchres.so.2`) — an artifact of the Buildroot cross-compile
output directory. This resolves correctly at runtime.

**RetroArch and libswitchres:** `ldd /usr/bin/retroarch | grep switch` returns nothing.
This confirms RetroArch uses its own **vendored, statically-linked** switchres (from
`deps/switchres/`) — it does not link against the system `libswitchres.so`.

---

## 2. /etc/switchres.ini — Live Configuration

**Monitor profile:** `ms929` (Nanao MS-929 — a well-known 15kHz arcade/CRT monitor)

Key active settings:
```ini
monitor              ms929
interlace_force_even 1        ← AMD DCN hardware on this machine (required)
dotclock_min         0        ← AMD GPU, no HDMI-only constraint
api                  auto     ← auto-selects xrandr on X11
modeline_generation  1        ← on-the-fly modeline generation enabled
interlace            1        ← interlaced modes allowed
h_size               1.0
h_shift              0
v_shift              0
pixel_precision      1        ← 1-pixel horizontal precision (not 8-pixel blocks)
```

All `crt_range0` through `crt_range9` are set to `auto` — the monitor profile (`ms929`)
defines the frequency ranges internally; these manual overrides are not needed.

---

## 3. Xorg Config Files — Live State

```
/etc/X11/xorg.conf.d/
├── 10-monitor.conf                    ← CRT output selection (written by CRT Script)
├── 10-monitor.conf.2025.11.05,16.17.46 ← timestamped backup made at install time
├── 15-crt-monitor.conf                ← generated by boot-custom.sh at every boot
├── 20-amdgpu.conf.bak                 ← original AMD config, backed up by CRT Script
├── 20-modesetting.conf                ← forces modesetting DDX (written by CRT Script)
├── 20-radeon.conf.bak                 ← original radeon config, backed up
├── 80-nvidia-egpu.conf                ← eGPU support (stock Batocera)
├── 99-avoid-joysticks.conf            ← prevents joysticks showing as pointer (stock)
└── 99-nvidia.conf                     ← NVIDIA geometry config (CRT Script)
```

### 10-monitor.conf (actual content)

```
# Generated by Batocera-CRT-Script (XRandR-only)
# Disables all outputs except the selected one

Section "Monitor"
    Identifier "DP-2"
    Option "Ignore" "true"
EndSection

Section "Monitor"
    Identifier "HDMI-1"
    Option "Ignore" "true"
EndSection

Section "Monitor"
    Identifier "HDMI-2"
    Option "Ignore" "true"
EndSection

Section "Monitor"
    Identifier "DP-1"
EndSection
```

**Key observations:**
- `DP-1` is the active CRT output — no `"Ignore"` option, no `"Enable"` needed; absence of
  Ignore is sufficient for Xorg to use it
- `DP-2`, `HDMI-1`, `HDMI-2` are all disabled
- The CRT Script generates this file during Phase 2 install based on user's output selection

### 15-crt-monitor.conf (actual content — generated at boot)

```
Section "Monitor"
    Identifier  "CRT"
    VendorName  "BATOCERA_CRT_SCRIPT"
    HorizSync   15-16.5
    VertRefresh 49-65
    Option      "DPMS" "False"
    Option      "DefaultModes" "False"
EndSection

Section "Device"
    Identifier "modesetting-amd-crt-bind"
    Driver "modesetting"
    Option "Monitor-DP-1" "CRT"
EndSection
```

**Key observations:**
- `HorizSync 15-16.5 kHz` — 15kHz horizontal sync range for CRT
- `VertRefresh 49-65 Hz` — covers both 50Hz (PAL) and 60Hz (NTSC) refresh rates
- `Option "DPMS" "False"` — disables power management (CRTs don't sleep)
- `Option "DefaultModes" "False"` — prevents Xorg from adding its own default modes;
  only switchres-generated modelines are used
- `Option "Monitor-DP-1" "CRT"` — binds the "CRT" monitor section to the DP-1 output.
  This is in a `Device` section using `modesetting` driver — the critical link between
  the monitor frequency constraints and the physical output.

### 20-modesetting.conf (actual content)

```
Section "OutputClass"
    Identifier "AMD via modesetting (amdgpu)"
    MatchDriver "amdgpu"
    Driver "modesetting"
    Option "TearFree" "false"
    Option "VariableRefresh" "false"
EndSection

Section "OutputClass"
    Identifier "AMD via modesetting (radeon)"
    MatchDriver "radeon"
    Driver "modesetting"
    Option "TearFree" "false"
EndSection
```

**Key observations:**
- Uses `OutputClass` + `MatchDriver` (not a bare `Device` section) — this is the correct
  modern Xorg approach. It targets AMD GPUs specifically (both `amdgpu` and `radeon` kernel
  drivers) and redirects them to `modesetting` DDX.
- `TearFree "false"` — critical. TearFree inserts a shadow framebuffer and blit path that
  blocks direct KMS page flips. On a CRT, this adds latency and breaks timing.
- `VariableRefresh "false"` — VRR/FreeSync is meaningless for fixed CRT timings and could
  interfere with precise modeline timing.

---

## 4. EDID Firmware — Live State

**File:** `/lib/firmware/edid/ms929.bin`

Named after the monitor profile (`ms929`), not `custom.bin`. The `boot-custom.sh` script
prioritizes `custom.bin` first, then falls back to the filename from the kernel cmdline,
then any `.bin` file in the directory. In this setup `ms929.bin` is the file being used.

**Kernel parameter confirming it is loaded:**
```
drm.edid_firmware=DP-1:edid/ms929.bin
```

Format: `OUTPUT:edid/FILENAME` — the output-specific format tells the kernel to apply
this EDID only when the DP-1 connector is present.

---

## 5. Kernel Command Line — Live CRT Parameters

**From `/proc/cmdline` (running kernel):**
```
label=BATOCERA console=tty3 quiet loglevel=0 vt.global_cursor_default=0
mitigations=off usbhid.jspoll=0 xpad.cpoll=0
drm.edid_firmware=DP-1:edid/ms929.bin
video=DP-1:e
initrd=/boot/initrd.gz
```

**CRT-specific parameters:**

| Parameter | Purpose |
|---|---|
| `drm.edid_firmware=DP-1:edid/ms929.bin` | Load custom EDID for DP-1 at kernel DRM level |
| `video=DP-1:e` | Enable DP-1 output at kernel level (force it active) |

**Important:** The format is `video=OUTPUT:e` — the `:e` suffix means "enable". This is
different from the format used in some older documentation. Together, these two parameters
ensure the CRT output is active and using the custom EDID **before Xorg even starts**.

---

## 6. syslinux.cfg — Where CRT Parameters Live

```
LABEL batocera
    MENU LABEL Batocera.linux (^normal)
    MENU DEFAULT
    LINUX /boot/linux
    APPEND label=BATOCERA console=tty3 quiet loglevel=0 vt.global_cursor_default=0
           mitigations=off usbhid.jspoll=0 xpad.cpoll=0
           drm.edid_firmware=DP-1:edid/ms929.bin video=DP-1:e
    INITRD /boot/initrd.gz
```

**Observation:** The CRT kernel parameters are in `syslinux.cfg` — not `grub.cfg`. The
`grub.cfg` on this machine is still the stock Batocera version (no CRT params). This means
this machine boots via **legacy BIOS/syslinux**, not EFI/GRUB.

The `grub.cfg` is present in `/boot/EFI/BOOT/` but unused on this machine — it's there
because Batocera ships both bootloaders.

> ⚠️ **Superseded conclusion — do not use for v43 implementation:**
>
> This document originally concluded: *"EFI machines → CRT params go in the CRT menuentry
> in grub.cfg; BIOS machines → CRT params go in the CRT LABEL in syslinux.cfg."*
>
> This is **incorrect for the v43 dual-boot architecture**. The vanilla X11 v43
> investigation (`vanilla-x11-v43-live-findings.md`) confirmed that `drm.edid_firmware=`
> and `video=OUTPUT:e` are **not required in the Phase 1 boot entry**. Xorg and xrandr
> function correctly on vanilla X11 v43 without any CRT kernel params. The params seen
> here were written by Phase 2 of the CRT Script into `syslinux.cfg` on this v42 machine.
>
> **Current architecture** (`x11-image-extraction-and-boot-requirements.md`):
> - **Phase 1** writes a clean CRT GRUB/syslinux entry with no CRT kernel params
> - **Phase 2** may add `drm.edid_firmware=` and `video=OUTPUT:e` to the CRT entry
>   if required for the specific monitor/connector — determined after connector identification
> - The CRT Script must still detect EFI vs BIOS to modify the correct config file

---

## 7. boot-custom.sh — Live Script (on boot partition)

**Critical discovery:** `boot-custom.sh` is stored at `/boot/boot-custom.sh` — on the
**VFAT boot partition**, not inside the squashfs. The squashfs `S00bootcustom` init script
just calls it:

```bash
# /etc/init.d/S00bootcustom
if test -e "/boot/boot-custom.sh"; then
    bash /boot/boot-custom.sh $1
fi
```

This has major implications for the dual-boot architecture:
- `S00bootcustom` is in the squashfs overlay (runs on every boot from that squashfs)
- `boot-custom.sh` is on the shared VFAT boot partition — readable by both boots
- The CRT Script must write `boot-custom.sh` to `/boot/` (boot partition) not to the
  squashfs. This file survives across squashfs updates.

**What boot-custom.sh does (confirmed live):**
1. Reads `10-monitor.conf` with `awk` to find which output has no `Ignore` option
2. Falls back to scanning `/sys/class/drm/card*-*/status` if `10-monitor.conf` is missing
3. Prioritizes EDID file: `custom.bin` > kernel cmdline EDID > first `.bin` file
4. Runs `edid-decode` to extract `HorizSync` and `VertRefresh` from the EDID binary
5. Hardcodes fallbacks (`HR="15-16.5"`, `VR="49-65"`) if EDID decode fails
6. Writes `/etc/X11/xorg.conf.d/15-crt-monitor.conf` before X11 starts

---

## 8. xrandr — Live Display State

```
Screen 0: minimum 320x200, current 769x576, maximum 16384x16384
DP-1 connected primary 769x576+0+0 485mm x 364mm
   769x576i      50.00*+
   640x480       50.00
   769x576       50.00
```

**Observations:**
- Current mode: `769x576i` at 50Hz — interlaced PAL boot resolution (the `i` = interlaced)
- Only DP-1 is listed — all other outputs (`DP-2`, `HDMI-1`, `HDMI-2`) are suppressed by
  `10-monitor.conf`. They don't even appear in xrandr output.
- Three modes available at boot: the interlaced 576i (active), and two progressive modes.
  These come from the custom EDID (`ms929.bin`).
- Maximum screen size is 16384×16384 — modesetting driver, no artificial cap.

---

## 9. batocera-resolution — Patched Script Analysis

The live `/usr/bin/batocera-resolution` is the **CRT Script patched version**, not the
stock Batocera xorg script. Key differences from stock confirmed in the live code:

**Added at top — modeline state tracking:**
```bash
STATE_FILE="/tmp/switchres-last-resolution-state"
# On each call: reads STATE_FILE, deletes old modeline via xrandr --delmode + --rmmode
# then removes STATE_FILE so next call starts clean
```

**setMode — calls switchres (not stock cvt):**
The `setMode` command reads `videomodes.conf`, extracts geometry, calls `switchres ... -c`,
then applies the resulting modeline via xrandr.

**setMode_CVT — fallback that checks videomodes.conf first:**
```bash
if is_mode_in_videomodes_conf "$MODE"; then
    _set_mode_from_videomodes_conf "$MODE"   # use switchres path
    exit 0
fi
# otherwise falls back to cvt
```

**defineMode — direct switchres call:**
```bash
MODE_xrandr=$(switchres $WIDTH $HEIGHT $PARTHZ -f ${WIDTH}x${HEIGHT}@${PARTHZ} -i switchres.ini -c)
```

**Debug log:** All operations are logged to `/userdata/system/logs/display.log`

**Game info log:** After each `setMode`, writes a debug file with:
```
Resolution of research=<MODE_Search>
Resolution_input=<MODE>
Monitor_name=<Monitor_name>
Monitor for ES=<Monitor_custom>
crt_range for game (applied when non-custom)=<crt_range_setmode>
game_switchres=<game_switchres>
```

---

## 10. videomodes.conf — Live Database

**62 entries total.** Format confirmed:

```
<MODE_ID>:<Display Name> <H_size>:<H_shift>:<V_shift> <Freq_label> <Hz_label>
```

**Sample entries:**
```
320x240.60.00010:320x240 1.0:0:0 15KHz 60Hz
640x480.60.00040:640x480 1.0:0:0 15KHz 60Hz
769x576.50.00060:Boot_576i 1.0:0:0 15KHz 50Hz    ← current boot mode
854x480.60.00045:854x480 1.0:0:0 15KHz 60Hz
1072x400.50.00052:1072x400 1.0:0:0 24KHz 50Hz     ← only 24kHz entry
```

**Key observations:**
- Mode IDs end in a 5-digit index (`.00001` to `.00062`) — not purely a framerate suffix.
  The format is `WIDTHxHEIGHT.FREQ.INDEX`
- All entries use geometry `1.0:0:0` — no geometry correction applied on this system
- Only one 24kHz mode (`1072x400`) — this system is primarily 15kHz
- Super-resolution modes present: `1280x240`, `1920x256`, `2560x448`, `3600x480`
- Boot modes at end: `641x480` (480i), `769x576` (576i), `1028x576` (576p)

---

## 11. batocera.conf — CRT-Specific Settings

From the live `batocera.conf` (CRT-relevant lines):

```bash
global.videooutput=DP-1                          # CRT output port
es.resolution=769x576.50.00060                   # boot resolution (576i PAL)
es.customsargs=--screensize 769 576 --screenoffset 00 00  # ES window size

# RetroArch CRT switching
global.retroarch.crt_switch_resolution = "4"     # enable CRT switching (mode 4)
global.retroarch.crt_switch_resolution_super = "0"
global.retroarch.crt_switch_hires_menu = "true"
global.retroarch.desktop_menu_enable = "false"

# System emulator routing — CRT tool placeholder
CRT.emulator=sh
CRT.core=sh

# MAME — switchres enabled
mame.switchres=1
neogeo.switchres=1
apple2.switchres=1
bbc.switchres=1
electron.switchres=1
# ... more mame-based systems

# Per-game video mode overrides (non-CRT resolutions for specific games)
lindbergh["vf5fs.game"].videomode=854x480.60.00045
batoparrot["Asura The Striker.wsquashfs"].videomode=640x480.60.00040
steam[" - ASURA THE STRIKER -.steam"].videomode=854x480.60.00045
```

**Key observations:**

1. **`global.retroarch.crt_switch_resolution = "4"`** — RetroArch CRT mode 4 is "Ultra-wide
   super resolution" mode. This tells RetroArch's internal switchres to generate ultra-wide
   super-resolution modelines for the active CRT.

2. **`CRT.emulator=sh` / `CRT.core=sh`** — The CRT system entry in EmulationStation uses
   a shell script (`sh`) as both emulator and core. This is how the CRT Tool apps (geometry,
   mode switcher) are launched from the CRT section in ES.

3. **`mame.switchres=1`** — Per-system switchres flag. Configgen reads this to add
   `-modeline_generation -changeres -modesetting -readconfig` to the MAME command line.

4. **Per-game `videomode` overrides** — Individual games can override the resolution via
   `batocera.conf`. This uses the same `MODE_ID` format as `videomodes.conf`. The system
   routes these through `batocera-resolution setMode` before the emulator launches.

---

## 12. batocera-boot.conf — Boot Partition Config

```
sharedevice=NETWORK
sharenetwork_smb1=ROMS@10.23.6.185:Batocera/roms:...
sharenetwork_smb1=THEMES@10.23.6.185:Batocera/themes:...
sharenetwork_smb1=MUSIC@10.23.6.185:Batocera/music:...
sharenetwork_smb1=LIBRARY@10.23.6.185:Batocera/library:...
sharenetwork_smb1=SCREENSHOTS@10.23.6.185:Batocera/screenshots:...
es.resolution=769x576.50.00060
amdgpu=true
```

**Key observations:**
- This system uses **SMB network shares** for ROMs, themes, music, library, screenshots
- `amdgpu=true` — AMD GPU in use (confirms `interlace_force_even 1` in switchres.ini)
- `es.resolution` is duplicated in both `batocera-boot.conf` and `batocera.conf` — the
  boot conf version is read early at boot before `/userdata` is mounted

---

## 13. Differences from Codebase Analysis

The live system revealed several things not evident from the batocera.linux source:

| Topic | Codebase analysis said | Live system shows |
|---|---|---|
| EDID filename | `custom.bin` | `ms929.bin` (named after monitor profile) |
| boot-custom.sh location | In squashfs | On VFAT boot partition (`/boot/boot-custom.sh`) |
| S00bootcustom | Contains the full script | Just a 5-line wrapper calling `/boot/boot-custom.sh` |
| Kernel EDID param format | `drm.edid_firmware=edid/custom.bin` | `drm.edid_firmware=DP-1:edid/ms929.bin video=DP-1:e` |
| Boot loader used | grub.cfg assumed | syslinux.cfg (BIOS machine) — grub.cfg is stock/unused |
| 20-modesetting.conf | Generic Device section | `OutputClass` + `MatchDriver` — more surgical AMD targeting |
| 15-crt-monitor.conf binding | `Option "Monitor-<OUT>" "CRT"` in Screen section | Same, but in a `Device` section using `modesetting` driver |
| drmConn | Written by CRT Script | Not present (`/var/run/drmConn` missing) — v42 may not use it |
| RetroArch CRT | crt_switch_resolution in retroarch.cfg | Set via `batocera.conf` as `global.retroarch.crt_switch_resolution = "4"` |

---

## 14. What This Means for the v43 Dual-Boot Build

**boot-custom.sh must go on the boot partition, not the squashfs:**
`S00bootcustom` (in squashfs) is a stub. The actual script at `/boot/boot-custom.sh` is
on the shared VFAT partition. In the dual-boot layout, this single file serves the CRT
X11 boot — the Wayland boot's S00bootcustom stub will call it too, but since Wayland
doesn't have `10-monitor.conf`, the script will gracefully exit after finding no enabled
output (or the CRT config will be generated but unused — harmless).

**EDID filename flexibility:**
The script accepts any `.bin` filename — `ms929.bin`, `custom.bin`, or anything. For v43,
the CRT Script can use either naming convention. `custom.bin` is the safest generic name.

**Kernel parameter format (must match exactly):**
```
drm.edid_firmware=DP-1:edid/custom.bin
video=DP-1:e
```
Both parameters required. The output-specific format (`DP-1:edid/...`) is important —
without it, the EDID is applied to all connected outputs, which can confuse HDMI monitors.

**EFI vs BIOS detection is critical:**
This live machine uses syslinux. The CRT Script must detect which bootloader is active and
modify the correct config. The grub.cfg is present but unused — checking for EFI boot
(via `efibootmgr` or `/sys/firmware/efi`) is the reliable method.

**The 20-modesetting.conf `OutputClass` approach:**
The live config uses `OutputClass` + `MatchDriver "amdgpu"` rather than a bare `Device`
section. This is more targeted — only AMD GPUs are redirected to modesetting DDX. Intel
and NVIDIA would need their own `OutputClass` entries. The CRT Script must generate the
appropriate `20-modesetting.conf` based on the detected GPU vendor.
