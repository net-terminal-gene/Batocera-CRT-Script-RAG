# X11 CRT Stack — Technical Requirements

**Date:** 2026-02-19
**Status:** Design / Planning
**Companion to:** `official-official-dual-boot-grub-architecture.md`, `beta-official-dual-boot-grub-architecture.md`

---

## Purpose

This document catalogues every tool, binary, config file, and runtime dependency that the
Batocera-CRT-Script requires from the X11 environment. It is the definitive checklist for
what must be present and configured inside the X11 squashfs boot image before CRT output
and per-system resolution switching can function.

---

## Overview of the CRT Signal Chain

```
Game launch (EmulationStation)
        │
        ▼
batocera-resolution setMode <MODE_ID>
        │
        ├── Reads videomodes.conf → geometry parameters for this mode
        │
        ▼
switchres <W> <H> <FREQ> -s -k -f <W>x<H>@<FREQ> -g "<geometry>" -i switchres.ini -c
        │
        ├── Outputs modeline string
        │
        ▼
xrandr --newmode <MODELINE>
xrandr --addmode <OUTPUT> <MODE>
xrandr --output <OUTPUT> --mode <MODE>
        │
        ├── X11 display mode is now set
        │
        ▼
Emulator launches at correct CRT resolution
```

---

## Required Binaries

### 1. switchres

**Role:** The core of the CRT resolution system. Generates monitor-specific modelines and
EDID binary files from a monitor profile and requested resolution.

**Must be present at:** `/usr/bin/switchres`

**How it is called:**

| Purpose | Command pattern |
|---|---|
| Generate EDID binary | `switchres <W> <H> <FREQ> -f <W>x<H>@<FREQ> -i switchres.ini -e` |
| Generate modeline string | `switchres <W> <H> <FREQ> -f <W>x<H>@<FREQ> -i switchres.ini -c` |
| Geometry-adjusted modeline | `switchres <W> <H> <FREQ> -s -k -f <W>x<H>@<FREQ> -g "<H_size>:<H_shift>:<V_shift>" -i switchres.ini -c` |

**Key flags:**
- `-e` — emit EDID `.bin` file
- `-c` — output modeline string
- `-f` — force this resolution/frequency format
- `-i` — path to switchres.ini config file
- `-s` — super resolution mode
- `-k` — keep existing modelines (don't wipe all modes)
- `-g` — geometry parameters: `H_size:H_shift:V_shift`

**Config it reads:** `/etc/switchres.ini`

---

### 2. xrandr

**Role:** Applies modelines to the X11 display server. The link between switchres modeline
output and what actually appears on the CRT.

**Must be present at:** `/usr/bin/xrandr`

**How it is called:**

```bash
# Query connected outputs and current modes
xrandr --query
xrandr --prop

# Add and apply a new modeline
xrandr --newmode <MODELINE_STRING>
xrandr --addmode <OUTPUT> <MODE_NAME>
xrandr --output <OUTPUT> --mode <MODE_NAME>

# Remove an old modeline (done before applying new one)
xrandr --delmode <OUTPUT> <OLD_MODE_NAME>
xrandr --rmmode <OLD_MODE_NAME>
```

**Critical note:** xrandr requires a live X11 session (`DISPLAY` env var set). This is
why Phase 2 of the install (CRT config) must run after the first reboot into X11 — xrandr
cannot reliably enumerate real display connectors (eDP-1, DP-1, VGA-1) from a Wayland session.

---

### 3. batocera-resolution (patched)

**Role:** The bridge between EmulationStation game launches and the xrandr/switchres chain.
EmulatorLauncher calls `batocera-resolution setMode <MODE_ID>` before launching any emulator.

**Must be present at:** `/usr/bin/batocera-resolution`

**Critical:** The CRT Script replaces the stock Batocera `batocera-resolution` binary with a
patched version. The patched version:
- Reads `videomodes.conf` to look up geometry parameters for the requested mode
- Honors `/etc/switchres.ini` monitor profile (does not override it)
- Prevents conflicting `crt_range` mixes
- Deletes the previous switchres modeline before applying the new one (prevents stale modes)
- Passes geometry (`-g`) to switchres for per-mode geometry correction

**Mode ID format:** `WIDTHxHEIGHT.FRAMERATE000`
Example: `640x480.60000` (320x240 doubled, 60Hz, 15kHz signal)

---

### 4. edid-decode

**Role:** Reads the EDID binary file generated by switchres and extracts `HorizSync` and
`VertRefresh` ranges. Used at boot by `boot-custom.sh` to generate the Xorg monitor config.

**Must be present at:** `/usr/bin/edid-decode`

**How it is called:**

```bash
edid-decode /lib/firmware/edid/custom.bin
# Output parsed → HorizSync and VertRefresh values extracted
# → Written to /etc/X11/xorg.conf.d/15-crt-monitor.conf
```

---

### 5. Xorg (modesetting DDX)

**Role:** The X11 display server. Must use the `modesetting` DDX driver (not `amdgpu` or
`radeon` DDX) to allow switchres/xrandr modeline injection.

**Forced by:** `/etc/X11/xorg.conf.d/20-modesetting.conf`

```
Section "Device"
    Identifier  "Card0"
    Driver      "modesetting"
EndSection
```

Using the vendor DDX (amdgpu/radeon) prevents modeline injection entirely — xrandr cannot
add arbitrary modelines when the vendor DDX manages the output directly.

---

## Required Config Files

### /etc/switchres.ini

**Role:** Tells switchres which monitor profile to use and its frequency capabilities.

**Written by:** `Batocera-CRT-Script-v43.sh` during installation (based on user's monitor
profile selection).

**Key fields:**

```ini
monitor <PROFILE_NAME>      # e.g. generic_15, arcade_15, ntsc, pal
interlace_force_even 1      # Set to 1 for AMD DCN (GCN 3.0+), 0 for DCE/older
dotclock_min 0              # 0 for AMD/NVIDIA, 25.0 for HDMI-only outputs
```

**Available monitor profiles:**

| Category | Profiles |
|---|---|
| Generic 15kHz | `generic_15`, `ntsc`, `pal` |
| Arcade 15kHz | `arcade_15`, `arcade_15ex` |
| Arcade 25/31kHz | `arcade_25`, `arcade_31` |
| Multi-sync | `arcade_15_25`, `arcade_15_31`, `arcade_15_25_31` |
| VESA | `vesa_480`, `vesa_600`, `vesa_768`, `vesa_1024` |
| Brand-specific | `h9110`, `k7000`, `d9200`, `m2929`, and others |

The profile defines `crt_range0` through `crt_range9` — the horizontal and vertical
frequency windows switchres uses to validate and generate modelines. If the requested
resolution falls outside a range, switchres will refuse or generate a fallback.

---

### /userdata/system/videomodes.conf

**Role:** Maps mode IDs (as called by `batocera-resolution`) to human-readable names and
geometry correction parameters. This is the per-system resolution database.

**Written by:** `Batocera-CRT-Script-v43.sh` during installation (copies template from
`System_configs/VideoModes/` based on GPU type).

**Format:**

```
MODE_ID:Display Name H_size:H_shift:V_shift Description
```

**Example entries:**

```
640x480.60000:320x240 1.0:0:0 15KHz 60Hz
768x576.50060:Boot_576i 1.0:0:0 15KHz 50Hz
1920x240.60000:1920x240 super 1.0:0:0 15KHz 60Hz
```

- `MODE_ID` — matches `WIDTHxHEIGHT.FRAMERATE000` format called by EmulationStation
- `H_size` — horizontal size multiplier (1.0 = full width)
- `H_shift` — horizontal position offset
- `V_shift` — vertical position offset

**GPU-specific templates** are stored in:
- `System_configs/VideoModes/Amd_NvidiaND_IntelDP/` — AMD, NVIDIA (nouveau), Intel (DP)
- `System_configs/VideoModes/Intel_NvidiaNOUV/` — Intel (VGA), NVIDIA (proprietary)

---

### /etc/X11/xorg.conf.d/10-monitor.conf

**Role:** Disables all video outputs except the selected CRT output. Prevents X11 from
presenting a desktop on HDMI/DisplayPort monitors plugged into the machine alongside the CRT.

**Written by:** `Batocera-CRT-Script-v43.sh` during installation (based on user's output
port selection).

**Structure:**

```
Section "Monitor"
    Identifier "<IGNORED_OUTPUT>"
    Option "Ignore" "true"
EndSection

Section "Monitor"
    Identifier "<CRT_OUTPUT>"
    Option "Enable" "true"
EndSection
```

All outputs except the CRT port get `Option "Ignore" "true"`. Typically one of:
`DP-1`, `HDMI-1`, `VGA-1`, `DVI-I-1`, `DVI-D-1`

---

### /etc/X11/xorg.conf.d/15-crt-monitor.conf

**Role:** Defines the `HorizSync` and `VertRefresh` ranges for the CRT monitor and binds
it to the selected output. Without this, Xorg may reject modelines that fall outside its
default safe ranges.

**Generated by:** `boot-custom.sh` at every boot (reads EDID, extracts ranges via `edid-decode`).

```
Section "Monitor"
    Identifier   "CRT"
    HorizSync    15.0-16.0
    VertRefresh  49.0-65.0
EndSection

Section "Screen"
    Identifier  "Screen0"
    Monitor     "CRT"
    Option      "Monitor-<OUTPUT>" "CRT"
EndSection
```

---

### /etc/X11/xorg.conf.d/20-modesetting.conf

**Role:** Forces Xorg to use the modesetting DDX driver instead of the vendor DDX. Required
for xrandr modeline injection to work.

**Written by:** `Batocera-CRT-Script-v43.sh` during installation.

```
Section "Device"
    Identifier  "Card0"
    Driver      "modesetting"
EndSection
```

---

### /lib/firmware/edid/custom.bin

**Role:** Custom EDID binary generated by switchres for the selected boot resolution. Loaded
by the kernel via the `drm.edid_firmware=edid/custom.bin` kernel parameter. Tells the GPU
what resolution to present at boot before X11 starts.

**Generated by:** `Batocera-CRT-Script-v43.sh` during installation using
`switchres ... -e` then copied to `/lib/firmware/edid/`.

---

### /boot/boot/syslinux.cfg (or grub.cfg)

**Role:** Kernel command line. The CRT-specific kernel parameters are added here during
installation and must be present in the CRT boot entry.

**Added parameters:**

```
drm.edid_firmware=edid/custom.bin
```

Some GPUs also need:
```
video=<OUTPUT>:<W>x<H>@<FREQ>
```

**In the dual-boot layout**, these parameters belong **only** in the CRT `menuentry` (the
entry that loads `initrd-crt.gz`). The Wayland entry must not have them.

---

### /etc/init.d/S00bootcustom → boot-custom.sh

**Role:** Runs at every X11 boot before the X server starts. Generates the dynamic Xorg
config (`15-crt-monitor.conf`) from the EDID binary.

**What it does:**
1. Reads `10-monitor.conf` to find which output is enabled (the CRT port)
2. Locates the EDID binary (`custom.bin` or from kernel cmdline)
3. Runs `edid-decode` to extract `HorizSync` / `VertRefresh` ranges
4. Writes `/etc/X11/xorg.conf.d/15-crt-monitor.conf` with those ranges
5. Binds the monitor to the output with `Option "Monitor-<OUTPUT>" "CRT"`

This must run before `S01xinit` or equivalent X11 startup. If it does not run, Xorg starts
without monitor range constraints and will likely reject CRT modelines.

---

## Runtime Dependency: DISPLAY Environment Variable

All xrandr calls require `DISPLAY` to be set (e.g., `DISPLAY=:0`). When `batocera-resolution`
is called from EmulatorLauncher during a game launch, this is inherited from the EmulationStation
session. If calling xrandr manually via SSH, you must set it:

```bash
DISPLAY=:0 xrandr --query
```

---

## Per-System Resolution Switching — Full Runtime Flow

```
1. User selects a game in EmulationStation
        │
        ▼
2. EmulatorLauncher reads system's core/emulator config
        │
        ▼
3. EmulatorLauncher calls:
   batocera-resolution setMode <MODE_ID>
   (e.g., setMode 640x480.60000)
        │
        ▼
4. batocera-resolution reads /userdata/system/videomodes.conf
   → Finds entry: 640x480.60000:320x240 1.0:0:0 15KHz 60Hz
   → Extracts geometry: H_size=1.0, H_shift=0, V_shift=0
        │
        ▼
5. batocera-resolution calls switchres:
   switchres 640 480 60 -s -k -f 640x480@60 -g "1.0:0:0" -i /etc/switchres.ini -c
   → Returns: modeline string (e.g., "640x480_60 13.500 640 664 ...")
        │
        ▼
6. batocera-resolution removes old switchres modeline (if different):
   xrandr --delmode <OUTPUT> <OLD_MODE>
   xrandr --rmmode <OLD_MODE>
        │
        ▼
7. batocera-resolution applies new modeline:
   xrandr --newmode 640x480_60 13.500 640 664 ...
   xrandr --addmode <OUTPUT> 640x480_60
   xrandr --output <OUTPUT> --mode 640x480_60
        │
        ▼
8. X11 output is now at CRT resolution
        │
        ▼
9. Emulator launches, renders at that resolution
```

---

## Geometry Adjustment (geometry.sh)

Beyond per-system modelines, the CRT Script includes a geometry adjustment tool that lets
users fine-tune the physical image position and size on screen.

**Tool:** `geometry.sh` + `/usr/bin/geometry` (Python helper)

**Flow:**
1. Reads current boot resolution from `/userdata/system/logs/BootRes.log`
2. User adjusts `H_size`, `H_shift`, `V_shift` values
3. Calls `switchres ... -g "<H_size>:<H_shift>:<V_shift>" -i switchres.ini -c`
4. Updates `switchres.ini` with new `crt_range0` to persist the adjustment
5. For NVIDIA: updates `/etc/X11/xorg.conf.d/99-nvidia.conf` with new modeline directly

---

## Mode Switcher (HD ↔ CRT) — What It Touches

`mode_switcher.sh` and its four modules manage the full switch between Wayland HD Mode and
X11 CRT Mode. With the dual-boot GRUB architecture, GRUB default selection is the primary
switch mechanism, but the mode switcher still manages everything inside `/userdata/`.

### What it backs up and restores:

| File/Setting | CRT Mode | HD Mode |
|---|---|---|
| `/userdata/system/batocera.conf` | CRT-specific version | HD-specific version |
| `/userdata/system/videomodes.conf` | Present (CRT mode DB) | Absent |
| `/boot/boot/syslinux.cfg` | With `drm.edid_firmware` params | Without CRT params |
| `/boot/boot/overlay` | CRT overlay (X11 configs, patched binaries) | Removed |
| `batocera.conf global.videooutput` | CRT output port (e.g. DP-1) | HD output port (e.g. HDMI-1) |
| `batocera.conf global.videomode` | CRT mode ID | HD mode ID |
| `/userdata/roms/crt/` | CRT tool apps present | Absent |

### Output detection at switch time:

The mode switcher scans `/sys/class/drm/card*-*/status` to find connected outputs — not
xrandr — because the switch may happen while booted into either mode.

### GRUB addition (new for dual-boot):

In addition to the above, the switcher now changes `set default` in `/boot/EFI/BOOT/grub.cfg`:
- Switch to CRT: `set default="1"` → boots X11 entry
- Switch to HD: `set default="0"` → boots Wayland entry

---

## Summary: What Must Be Present in the X11 Squashfs

For the CRT Script to function after booting the X11 squashfs, the following must exist
in that image or be installed into it by the CRT Script during Phase 2:

| Component | Location | Source |
|---|---|---|
| `switchres` binary | `/usr/bin/switchres` | Installed by CRT Script |
| `xrandr` binary | `/usr/bin/xrandr` | Must be in X11 build |
| `batocera-resolution` (patched) | `/usr/bin/batocera-resolution` | Replaced by CRT Script |
| `edid-decode` | `/usr/bin/edid-decode` | Must be in X11 build |
| Xorg (modesetting DDX) | system | Must be in X11 build |
| `switchres.ini` | `/etc/switchres.ini` | Written by CRT Script (Phase 2) |
| `videomodes.conf` | `/userdata/system/` | Written by CRT Script (Phase 2) — survives reboot (shared partition) |
| `10-monitor.conf` | `/etc/X11/xorg.conf.d/` | Written by CRT Script (Phase 2) |
| `15-crt-monitor.conf` | `/etc/X11/xorg.conf.d/` | Generated by `boot-custom.sh` at every boot |
| `20-modesetting.conf` | `/etc/X11/xorg.conf.d/` | Written by CRT Script (Phase 2) |
| `custom.bin` (EDID) | `/lib/firmware/edid/` | Generated by CRT Script (Phase 2) via switchres |
| `boot-custom.sh` / `S00bootcustom` | `/etc/init.d/` | Installed by CRT Script |
| CRT kernel params | `/boot/EFI/BOOT/grub.cfg` CRT entry | Added by CRT Script (Phase 1) |

**Items in `/userdata/`** (videomodes.conf, CRT tool configs, profiles) survive across both
boots automatically because `/userdata/` is the shared SHARE partition.

**Items in `/etc/` and `/lib/`** exist inside the squashfs overlay — they are part of the
X11 OS image and do not exist in the Wayland boot. This is why a separate X11 squashfs is
required rather than using the Wayland one.
